# Read configuration file
configfile: "config.yaml"
# Get Conda installation path from configuration file
conda_install_path = config["conda_install_path"]
# Initialize pre-run environment
shell.prefix(f"source ~/.bashrc; source {conda_install_path}/etc/profile.d/conda.sh; conda activate APIARC; ")
GROUPS = config["groups"]
print(GROUPS)

rule all:
    input:
        expand("data/INTEGRATEDPROJ/Promoter/file/{group}_all_peaks.bed", group=GROUPS),
        expand("data/INTEGRATEDPROJ/Promoter/file/{group}_down_peaks.bed", group=GROUPS),
        expand("data/INTEGRATEDPROJ/Promoter/file/{group}_up_peaks.bed", group=GROUPS),
        "data/INTEGRATEDPROJ/Promoter/file/GO_enrich_common_gene.csv",
        "data/INTEGRATEDPROJ/Promoter/file/KEGG_GSEA_common_gene.csv",
        "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_up_genes_plotProfile.pdf",
        "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_down_genes_plotProfile.pdf",
        "data/INTEGRATEDPROJ/Promoter/file/Motif_result_up_list.txt",
        "data/INTEGRATEDPROJ/Promoter/file/Motif_result_down_list.txt",
        "data/INTEGRATEDPROJ/Promoter/picture/TF_up_gene_heatmap.pdf",
        "data/INTEGRATEDPROJ/Promoter/picture/TF_down_gene_heatmap.pdf",
        "data/INTEGRATEDPROJ/Promoter/file/GO_network.graphml"

# Promoter Analysis and Visualization
rule promoter_plot:
    input:
        yaml = "data/INTEGRATEDPROJ/script/Promoter/config.yaml",
        matrix = "data/CHIPPROJ/Macs2/group_matrix.txt"
    output:
        expand("data/INTEGRATEDPROJ/Promoter/file/{group}_all_peaks.bed", group=GROUPS),
        expand("data/INTEGRATEDPROJ/Promoter/file/{group}_down_peaks.bed", group=GROUPS),
        expand("data/INTEGRATEDPROJ/Promoter/file/{group}_up_peaks.bed", group=GROUPS),
        "data/INTEGRATEDPROJ/Promoter/picture/RNA_ChIP_col_plot_same_direction.pdf",
        "data/INTEGRATEDPROJ/Promoter/picture/common_genes_volcano_plot.pdf",
        "data/INTEGRATEDPROJ/Promoter/picture/common_up_genes_venn_diagram.pdf",
        "data/INTEGRATEDPROJ/Promoter/picture/common_down_genes_venn_diagram.pdf",
        "data/INTEGRATEDPROJ/Promoter/file/GO_enrich_common_gene.csv",
        "data/INTEGRATEDPROJ/Promoter/file/KEGG_GSEA_common_gene.csv",
        "data/INTEGRATEDPROJ/Promoter/picture/KEGG_GSEA_Top10_Multipage.pdf"
    params:
        RNAseq = "data/RNAPROJ/DEG/DEG_result.csv",
        ChIPseq = "data/CHIPPROJ/annotations",
        matrix = "data/CHIPPROJ/Macs2/group_matrix.txt",
        yaml = "data/INTEGRATEDPROJ/script/Promoter/config.yaml",  
        output = "data/INTEGRATEDPROJ/Promoter/file",  
        pdf = "data/INTEGRATEDPROJ/Promoter/picture" 
    shell:
        """
        Rscript data/INTEGRATEDPROJ/script/Promoter/Promoter_plot.R \
            --RNAseq {params.RNAseq} \
            --ChIPseq {params.ChIPseq} \
            --matrix {params.matrix} \
            --yaml {params.yaml} \
            --output {params.output} \
            --picture {params.pdf}
        """

# Transcription Factor Motif Enrichment Analysis
rule Motif_tf_Promoter:
    input:
        yaml = "data/INTEGRATEDPROJ/script/Promoter/config.yaml",
        bwfile = "data/CHIPPROJ/bam_bwfile/bambw_list.yaml",
        GOfile = "data/INTEGRATEDPROJ/Promoter/file/KEGG_GSEA_common_gene.csv"
    output:
        "data/INTEGRATEDPROJ/Promoter/file/Promoter_both_up_genes_target_seqs.fasta",
        "data/INTEGRATEDPROJ/Promoter/file/Promoter_both_down_genes_target_seqs.fasta",
        "data/INTEGRATEDPROJ/Promoter/file/TF_motif_network_up.txt",
        "data/INTEGRATEDPROJ/Promoter/file/TF_motif_network_down.txt",
        "data/INTEGRATEDPROJ/Promoter/file/TF_gene_mapping_up.txt",
        "data/INTEGRATEDPROJ/Promoter/file/TF_gene_mapping_down.txt",
        "data/INTEGRATEDPROJ/Promoter/file/Promoter_both_up_genes_matrix.gz",
        "data/INTEGRATEDPROJ/Promoter/file/Promoter_both_up_genes_signal.tab",
        "data/INTEGRATEDPROJ/Promoter/file/Promoter_both_down_genes_matrix.gz",
        "data/INTEGRATEDPROJ/Promoter/file/Promoter_both_down_genes_signal.tab",
        "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_up_genes_plotProfile.pdf",
        "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_down_genes_plotProfile.pdf"
    params:
        motifdir = "reference/Motif_tf_anno/JASPAR_CORE",
        motifmapfile = "reference/Motif_tf_anno/JASPAR_CORE_ID_to_NAME.txt",  
        groupfile = "data/INTEGRATEDPROJ/script/Promoter/config.yaml",  
        bwfile = "data/CHIPPROJ/bam_bwfile/bambw_list.yaml",
        outputdir = "data/INTEGRATEDPROJ/Promoter/file",
        outpic = "data/INTEGRATEDPROJ/Promoter/picture"
    shell:
        """
        perl data/INTEGRATEDPROJ/script/Promoter/TF_motif_enrichment_pipeline.pl \
            --motifdir {params.motifdir} \
            --motifmapfile {params.motifmapfile} \
            --groupfile {params.groupfile} \
            --bwfile {params.bwfile} \
            --outputdir {params.outputdir} \
            --outpic {params.outpic}
        """
rule Network_construction:
    input:
        GO_csv = "data/INTEGRATEDPROJ/Promoter/file/GO_enrich_common_gene.csv",
    output:
        "data/INTEGRATEDPROJ/Promoter/file/GO_network.graphml"
    params:
        GO_csv = "data/INTEGRATEDPROJ/Promoter/file/GO_enrich_common_gene.csv",
        graphml = "data/INTEGRATEDPROJ/Promoter/file"
    shell:
        """
        Rscript data/INTEGRATEDPROJ/script/Promoter/GO_Network_construction.R \
            -g {params.GO_csv} \
            -o {params.graphml}
        """
# Extract Enriched Motifs for Up-regulated Genes
rule extr_up_gene_enriched_motifs:
    input:
        motif_result1 = "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_up_genes_plotProfile.pdf",
        motif_result2 = "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_down_genes_plotProfile.pdf"
    output:
        "data/INTEGRATEDPROJ/Promoter/file/Motif_result_up_list.txt"
    params:
        yamlfile = "data/INTEGRATEDPROJ/script/Promoter/config.yaml",
        motifdir = "data/INTEGRATEDPROJ/Promoter/file/Motif_result_up"
    shell:
        """
        perl data/INTEGRATEDPROJ/script/Promoter/extr_enriched_motifs.pl \
            --yamlfile {params.yamlfile} \
            --motifdir {params.motifdir} \
        """

# Extract Enriched Motifs for Down-regulated Genes
rule extr_down_gene_enriched_motifs:
    input:
        motif_result1 = "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_up_genes_plotProfile.pdf",
        motif_result2 = "data/INTEGRATEDPROJ/Promoter/picture/Promoter_both_down_genes_plotProfile.pdf"
    output:
        "data/INTEGRATEDPROJ/Promoter/file/Motif_result_down_list.txt"
    params:
        yamlfile = "data/INTEGRATEDPROJ/script/Promoter/config.yaml",
        motifdir = "data/INTEGRATEDPROJ/Promoter/file/Motif_result_down"
    shell:
        """
        perl data/INTEGRATEDPROJ/script/Promoter/extr_enriched_motifs.pl \
            --yamlfile {params.yamlfile} \
            --motifdir {params.motifdir} \
        """
        
# Transcription Factor Heatmap for Up-regulated Genes
rule TF_motif_plot_up:
    input:
        TF_gene = "data/INTEGRATEDPROJ/Promoter/file/Motif_result_up_list.txt",
    output:
        "data/INTEGRATEDPROJ/Promoter/picture/TF_up_gene_heatmap.pdf"
    params:
        RNAseq = "data/RNAPROJ/DEG/DEG_result.csv",
        TF_gene = "data/INTEGRATEDPROJ/Promoter/file/Motif_result_up_list.txt",
        output = "data/INTEGRATEDPROJ/Promoter/file",
        picture = "data/INTEGRATEDPROJ/Promoter/picture/TF_up_gene_heatmap.pdf"
    shell:
        """
        Rscript data/INTEGRATEDPROJ/script/Promoter/TF_motif_plot.R \
            --RNAseq {params.RNAseq} \
            --TF_gene {params.TF_gene} \
            --output {params.output} \
            --picture {params.picture}
        """

# Transcription Factor Heatmap for Down-regulated Genes
rule TF_motif_plot_down:
    input:
        TF_gene = "data/INTEGRATEDPROJ/Promoter/file/Motif_result_down_list.txt",
    output:
        "data/INTEGRATEDPROJ/Promoter/picture/TF_down_gene_heatmap.pdf"
    params:
        RNAseq = "data/RNAPROJ/DEG/DEG_result.csv",
        TF_gene = "data/INTEGRATEDPROJ/Promoter/file/Motif_result_down_list.txt",
        output = "data/INTEGRATEDPROJ/Promoter/file",
        picture = "data/INTEGRATEDPROJ/Promoter/picture/TF_down_gene_heatmap.pdf"
    shell:
        """
        Rscript data/INTEGRATEDPROJ/script/Promoter/TF_motif_plot.R \
            --RNAseq {params.RNAseq} \
            --TF_gene {params.TF_gene} \
            --output {params.output} \
            --picture {params.picture}
        """